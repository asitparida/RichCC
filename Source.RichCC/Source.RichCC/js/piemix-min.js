!function(){"use strict";function e(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"_"+e()}String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.replaceAll=function(e,t){var n=new RegExp(e,"g");return this.replace(n,t)},angular.module("piemix.modules",["ngSanitize","ui.bootstrap"]).directive("pieMix",["$parse",function(t){return{restrict:"AEC",scope:{slices:"=",config:"=",callbackOnClick:"&"},templateUrl:"template/piemix/template.html",controller:["$scope","$timeout","$element","$attrs","$parse",function(t,n,r,a,i){var o=this;o._generateCoordinates=function(e,t,n){var r=e+"deg_"+t+"_rad"+n.toString();if("undefined"!=typeof o.coordinates[r]&&null!=o.coordinates[r])return o.coordinates[r];var a=0,i=0,c=Math.abs(t*Math.sin(.0174533*e)),d=Math.abs(t*Math.cos(.0174533*e));return e>=0&&90>=e?(a=n.x+c,i=n.y-d):e>=90&&180>=e?(a=n.x+c,i=n.y+d):e>=180&&270>=e?(a=n.x-c,i=n.y+d):(a=n.x-c,i=n.y-d),o.coordinates[r]={x:Math.ceil(a),y:Math.ceil(i)},o.coordinates[r]},o._generatePies=function(t,n,r){var a=_.reduce(t,function(e,t){return e+t.value},0),i=0;_.each(t,function(t,c){for(var d=0,u=o.baseRadius,l=o.baseRadius;n-1>d;)l*=o.radiusIncrementFactor,u+=l,d+=1;var s=360;"undefined"!=typeof r&&null!=r&&"undefined"!=typeof r.deg&&null!=r.deg&&(s=r.deg);var g=Math.ceil(t.value/a*s),f=i+g,x=i+g+("undefined"!=typeof t.degStart&&null!=t.degStart&&t.degStart!={}?t.degStart:0),y=i+(x-i)/2,p=o._generateCoordinates(i,u,o.centerXY),h=o._generateCoordinates(y,u,o.centerXY),m=o._generateCoordinates(x,u,o.centerXY),v=0;g>180&&(v=1),t._uid=e(),t.rad=u,t.deg=g,t.degStart=f-g,t.effectiveDeg=x,t.midDeg=y,t.degEnd=f,t.startXY=p,t.midXY=h,t.endXY=m,t.pathCoeff=v,t.activecolor=t.color,t.priority=n;var C="M"+t.startXY.x+" "+t.startXY.y+" A "+t.rad+" "+t.rad+", 0, "+t.pathCoeff+", 1, "+t.endXY.x+" "+t.endXY.y+" L "+o.centerXY.x+" "+o.centerXY.y+" Z";t.d=C;var S=_.clone(t);delete S.child,o.generatedPies.push(S),"undefined"!=typeof t.child&&t.child!={}&&t.child.length>0&&o._generatePies(t.child,n+1,t),i=f})},o._calDeepLength=function(e){var t=0;return e.length>0&&(t+=1),_.each(e,function(e){"undefined"!=typeof e.child&&e.child!={}&&e.child.length>0&&(t+=o._calDeepLength(e.child))}),t},o._calMaxRadius=function(e){for(var t=o._calDeepLength(e),n=o.baseRadius,r=0;t-1>r;)n+=o.baseRadius*o.radiusIncrementFactor,r+=1;return n},o.getContainerWidth=function(){return"undefined"!=typeof r&&null!=r?r.width():2*o._maxRad},o.getContainerHeight=function(){return"undefined"!=typeof r&&null!=r?r.height():2*o._maxRad},o._getCenterXY=function(e,t){o._maxRad=o._calMaxRadius(e);var n=o.getContainerWidth()/2;return t="undefined"!==t&&t!={}&&null!=t?t:0,{x:n,y:o._maxRad+2*t}},o._calcQuadrants=function(){var e={},t=o.getContainerWidth(),n=(o.getContainerHeight(),o.centerXY),r=o.gapToLabel,a=o._maxRad;return t-30>=a+r?(e.NE={x:n.x+a+r,y:10},e.NW={x:n.x-a-r,y:10},e.SE={x:n.x+a+r,y:n.y},e.SW={x:n.x-a-r,y:n.y},e):void 0},o._getQuadrantKey=function(e){var t="";return e>=0&&90>=e?t="NE":e>90&&180>=e?t="SE":e>180&&270>=e?t="SW":e>270&&360>=e&&(t="NW"),t},o._drawHelpBoxes=function(){var e={NE:0,SE:0,NW:0,SW:0},t=50,n=_.sortBy(angular.copy(o.generatedPies),function(e){return-e.priority}),r=o._calcQuadrants();_.each(n,function(n){e.id=n.id;var a=o._getQuadrantKey(n.midDeg),i=_.clone(r[a]);if(i.y=i.y+e[a],"NE"==a||"SE"==a){var c={x:i.x,y:i.y},d={x:i.x+100,y:i.y},u=n.midXY;n._ptr=u.x+","+u.y+" "+c.x+","+c.y+" "+d.x+","+d.y,n.colorBox={x:c.x,y:c.y+8},n.textBox={x:c.x+24,y:c.y+20},n.incr=e[a]}else if("NW"==a||"SW"==a){var c={x:i.x,y:i.y},d={x:i.x-100,y:i.y},u=n.midXY;n._ptr=d.x+","+d.y+" "+c.x+","+c.y+" "+u.x+","+u.y,n.colorBox={x:c.x-100,y:c.y+8},n.textBox={x:c.x-100+24,y:c.y+20},n.incr=e[a]}e[a]=e[a]+t;var l=_.find(o.generatedPies,function(e){return 0==e._uid.localeCompare(n._uid)});"undefined"!=typeof l&&null!=l&&l!={}&&(l.colorBox=n.colorBox,l.textBox=n.textBox,l.ptr=n._ptr,l.fillOpacity=1)})},o._startGenerating=function(e){o.generatedPies=[],o.centerXY=o._getCenterXY(e,5),o.svgWidth=o.getContainerWidth(),o.svgHeight=2*o._maxRad+100,o._generatePies(e,1,null),n(o._drawHelpBoxes,500)},o._init=function(e){this.baseRadius=angular.copy(o.config.baseRadius)||100,this.radiusIncrementFactor=angular.copy(o.config.radiusIncrementFactor)||.66,this.gapToLabel=angular.copy(o.config.gapToLabel)||60,o.coordinates={},o.generatedPies=[],o.centerXY={},o._maxRad={},o._startGenerating(e)},o.pieSliceClicked=function(e){o.callbackOnClick({data:e})}}],controllerAs:"piemixctrl",bindToController:!0,replace:!0,link:function(e,n,r,a){var i=[];angular.forEach(["slices","config"],function(n){if(r[n]){t(r[n]);i.push(e.$parent.$watch(angular.bind(a,function(){return this[n]}),function(e){a._init(angular.copy(a.slices))},!0))}})}}}])}();